<?xml version="1.0" encoding="utf-8"?>
<odoo>
  <data>

    <record id="crm_lead_view_form_inherit_mi_modulo_aduana" model="ir.ui.view">
      <field name="name">crm.lead.form.inherit.modulo_aduana_odoo.aduana</field>
      <field name="model">crm.lead</field>
      <field name="inherit_id" ref="crm.crm_lead_view_form"/>
      <field name="arch" type="xml">

        <!-- SMART BUTTON -->
        <xpath expr="//div[@class='oe_button_box']" position="inside">
          <button type="action"
                  name="%(modulo_aduana_odoo.mx_ped_operacion_action)d"
                  class="oe_stat_button"
                  icon="fa-file-text-o"
                  context="{'search_default_lead_id': id}">
            <field string="Pedimentos" name="x_ped_operacion_count" widget="statinfo"/>
          </button>
        </xpath>

        <!-- BOTÓN EN HEADER -->
        <xpath expr="//header" position="inside">
          <button name="action_crear_pedimento" type="object" string="Crear pedimento" class="btn-secondary"/>
          <button name="action_generate_pedimento_xml" 
                  type="object" 
                  string="Generar XML (MVP)" 
                  class="btn-primary" 
                  icon="fa-file-code-o"/>
        </xpath>

        <xpath expr="//notebook" position="inside">

          <page string="Operación" name="mi_modulo_operacion">
            <group>
              <group string="Identificación">
                <field name="x_tipo_operacion"/>
                <field name="x_folio_operacion"/>
                <field name="x_referencia_cliente"/>
                <field name="x_prioridad_operativa"/>
              </group>
              <group string="Responsables">
                <field name="x_ejecutivo_id"/>
                <field name="user_id"/>
                <field name="partner_id"/>
              </group>
            </group>
          </page>

          <page string="Aduana" name="mi_modulo_aduana">
            <group>
              <group string="Clasificación">
                <field name="x_regimen"/>
                <field name="x_tipo_despacho"/>
                <field name="x_aduana_seccion_despacho_id"/>
                <field name="x_aduana" readonly="1"/>
                <field name="x_aduana_seccion_entrada_salida_id"/>
                <field name="x_agente_aduanal_id" domain="[('x_contact_role','=','agente_aduanal')]"/>
                <field name="x_patente_agente" readonly="1"/>
                <field name="x_curp_agente"/>
                <field name="x_clave_pedimento_id"
                       domain="[('active','=',True), '|', ('tipo_operacion','=','ambas'), ('tipo_operacion','=',x_tipo_operacion), '|', ('regimen','=','cualquiera'), ('regimen','=',x_regimen)]"/>
                <field name="x_acuse_validacion"/>
              </group>
            </group>
          </page>

          <page string="Mercancía" name="mi_modulo_mercancia">
            <group>
              <group string="Descripción">
                <field name="x_fraccion_arancelaria_id"/>
                <field name="x_fraccion_arancelaria_principal" readonly="1"/>
                <field name="x_descripcion_mercancia"/>
                <field name="x_currency_id"/>
              </group>
            </group>
          </page>

          <page string="Partes" name="mi_modulo_partes">
            <group>
              <group string="Participantes">
                <field name="x_exportador_id"
                       domain="[('x_contact_role','in',['cliente','otro'])]"
                       invisible="x_tipo_operacion == 'importacion'"
                       required="x_tipo_operacion == 'exportacion'"/>
                <field name="x_exportador_name"
                       invisible="x_tipo_operacion == 'importacion'"/>
                <field name="x_importador_id"
                       domain="[('x_contact_role','in',['cliente','otro'])]"
                       invisible="x_tipo_operacion == 'exportacion'"
                       required="x_tipo_operacion == 'importacion'"/>
                <field name="x_importador_name"
                       invisible="x_tipo_operacion == 'exportacion'"/>
                <field name="x_proveedor_id" domain="[('x_contact_role','in',['proveedor','otro'])]"/>
                <field name="x_proveedor_name"/>
              </group>
              <group string="Destino">
                <field name="x_consignatario_name"/>
                <field name="x_destinatario_final_name"/>
              </group>
            </group>
          </page>

          <page string="Logística" name="mi_modulo_logistica">
            <group>
              <group string="Ruta">
                <field name="x_modo_transporte"/>
                <field name="x_incoterm"/>
                <field name="x_medio_transporte_salida"/>
                <field name="x_medio_transporte_arribo"/>
                <field name="x_medio_transporte_entrada_salida"/>
                <field name="x_origen_destino_mercancia"/>
                <field name="x_pais_origen_id"/>
                <field name="x_pais_destino_id"/>
                <field name="x_lugar_carga"/>
                <field name="x_lugar_descarga"/>
              </group>
              <group string="Fechas">
                <field name="x_fecha_estimada_salida"/>
                <field name="x_fecha_estimada_arribo"/>
                <field name="x_fecha_recoleccion"/>
                <field name="x_fecha_entrega"/>
              </group>
            </group>
          </page>

          <page string="Transporte" name="mi_modulo_transporte">
            <group>
              <group string="Guías">
                <field name="x_bl_awb"/>
                <field name="x_house_bl_awb"/>
                <field name="x_booking" modifiers='{"invisible":[["x_modo_transporte","!=","maritimo"]]}'/>
              </group>
              <group string="Equipo">
                <field name="x_num_contenedor"/>
                <field name="x_num_sello"/>
              </group>
              <group string="Transportista">
                <field name="x_transportista_id"/>
                <field name="x_transporte_pais_id"/>
                <field name="x_transporte_identificador"/>
              </group>
            </group>
          </page>

          <page string="Valores" name="mi_modulo_valores">
            <group>
              <group string="Importes">
                <field name="x_valor_factura"/>
                <field name="x_valor_aduana_estimado"/>
                <field name="x_cotizacion_total"/>
                <field name="x_costo_estimado"/>
                <field name="x_tipo_cambio"/>
              </group>
              <group string="Cantidades">
                <field name="x_bultos"/>
                <field name="x_numero_paquetes"/>
                <field name="x_tipo_empaque"/>
                <field name="x_peso_bruto"/>
                <field name="x_peso_neto"/>
                <field name="x_volumen_cbm"/>
              </group>
              <group string="Incrementables">
                <field name="x_incrementable_fletes"/>
                <field name="x_incrementable_seguros"/>
                <field name="x_incrementable_embalajes"/>
                <field name="x_incrementable_otros"/>
              </group>
              <group string="Decrementables">
                <field name="x_decrementable_fletes"/>
                <field name="x_decrementable_seguros"/>
                <field name="x_decrementable_carga"/>
                <field name="x_decrementable_descarga"/>
                <field name="x_decrementable_otros"/>
              </group>
            </group>
          </page>

          <page string="Documentos" name="mi_modulo_documentos">
            <group>
              <group string="Checklist">
                <field name="x_docs_requeridos_ids" widget="many2many_tags"/>
                <field name="x_docs_faltantes_text" placeholder="Ej. Falta factura, packing list, BL..."/>
                <field name="x_docs_completos" readonly="1"/>
              </group>
              <group string="Portal">
                <field name="x_visible_portal"/>
              </group>
              <group string="CFDI / Documento equivalente">
                <field name="x_cfdi_fecha"/>
                <field name="x_cfdi_numero"/>
                <field name="x_cfdi_termino_facturacion"/>
                <field name="x_cfdi_moneda_id"/>
                <field name="x_cfdi_valor_usd"/>
                <field name="x_cfdi_valor_moneda"/>
                <field name="x_cfdi_pais_id"/>
                <field name="x_cfdi_estado_id"/>
                <field name="x_cfdi_id_fiscal"/>
              </group>
            </group>
          </page>

          <page string="Importación" name="mi_modulo_importacion"
                invisible="x_tipo_operacion != 'importacion'">

            <group>
              <group string="Compra / proveedor">
                <field name="x_purchase_order"/>
                <field name="x_proveedor_invoice_number"/>
                <field name="x_condiciones_pago"/>
                <field name="x_tipo_compra"/>
              </group>
              <group string="Regulaciones">
                <field name="x_permisos_ids" widget="many2many_tags"/>
                <field name="x_normas_noms_text"/>
                <field name="x_etiquetado"/>
                <field name="x_cumplimiento_noms"/>
                <field name="x_certificado_origen"/>
                <field name="x_tratado_aplicable"/>
                <field name="x_pedimento_rectificacion"/>
              </group>
            </group>

            <group>
              <group string="Impuestos (estimados)">
                <field name="x_iva_estimado"/>
                <field name="x_igi_estimado"/>
                <field name="x_dta_estimado"/>
                <field name="x_prv_estimado"/>
                <field name="x_total_impuestos_estimado"/>
                <field name="x_total_pagado_real"/>
              </group>
              <group string="Recinto / entrega">
                <field name="x_recinto_fiscalizado"/>
                <field name="x_almacenaje"/>
                <field name="x_citas_almacen"/>
                <field name="x_transportista_entrega"/>
                <field name="x_direccion_entrega_final"/>
              </group>
            </group>

          </page>

          <page string="Exportación" name="mi_modulo_exportacion"
                invisible="x_tipo_operacion != 'exportacion'">

            <group>
              <group string="Venta">
                <field name="x_sales_order"/>
                <field name="x_invoice_export_number"/>
                <field name="x_cliente_extranjero_name"/>
                <field name="x_direccion_destino_final"/>
                <field name="x_condiciones_venta"/>
              </group>
              <group string="Compliance">
                <field name="x_regulaciones_exportacion_ids" widget="many2many_tags"/>
                <field name="x_certificados_exportacion_ids" widget="many2many_tags"/>
                <field name="x_licencia_exportacion"/>
                <field name="x_motivo_exportacion"/>
              </group>
            </group>

            <group>
              <group string="Salida">
                <field name="x_punto_salida"/>
                <field name="x_transportista_salida"/>
                <field name="x_fecha_cruce"/>
                <field name="x_fecha_zarpe"/>
                <field name="x_fecha_vuelo"/>
                <field name="x_prueba_entrega"/>
              </group>
            </group>

          </page>

          <page string="Facturación" name="mi_modulo_facturacion">
            <group>
              <group string="Cobro">
                <field name="x_factura_emitida"/>
                <field name="x_factura_ref" modifiers='{"invisible":[["x_factura_emitida","=",false]]}'/>
                <field name="x_metodo_cobro"/>
                <field name="x_pago_confirmado"/>
              </group>
              <group string="Notas internas">
                <field name="description" placeholder="Agrega observaciones relevantes de la operación..."/>
              </group>
            </group>
          </page>

          <!-- ✅ Pedimento en LEAD: SOLO RESUMEN (READ-ONLY) -->
          <page string="Pedimentos" name="mi_modulo_pedimentos_rel">
            <group>
              <group string="Acciones">
                <button name="action_crear_pedimento" type="object" string="Crear pedimento desde este lead" class="btn-primary"/>
              </group>
            </group>

            <field name="x_ped_operacion_ids"
                   nolabel="1"
                   context="{'default_lead_id': id}"
                   mode="list,form">

              <list editable="bottom">
                <field name="name"/>
                <field name="tipo_operacion"/>
                <field name="regimen"/>
                <field name="aduana_clave"/>
                <field name="agente_aduanal_id"/>
                <field name="patente"/>
                <field name="clave_pedimento_id"/>
                <field name="pedimento_numero"/>
                <field name="fecha_pago"/>
                <field name="fecha_liberacion"/>
                <field name="semaforo"/>
              </list>

              <form string="Pedimento">
                <header>
                  <button name="action_cargar_desde_lead" type="object" string="Cargar desde Lead" class="btn-secondary"/>
                </header>
                <sheet>
                  <div class="oe_title">
                    <h1>
                      <field name="name" placeholder="Ej. EXP-000123 / OP-00045"/>
                    </h1>
                  </div>

                  <group>
                    <group string="Clasificación">
                      <field name="lead_id" readonly="1"/>
                      <field name="tipo_operacion"/>
                      <field name="regimen"/>
                      <field name="incoterm"/>
                      <field name="aduana_clave"/>
                      <field name="agente_aduanal_id" domain="[('x_contact_role','=','agente_aduanal')]"/>
                      <field name="patente" readonly="1"/>
                      <field name="clave_pedimento_id"
                             domain="[('active','=',True), '|', ('tipo_operacion','=','ambas'), ('tipo_operacion','=',tipo_operacion), '|', ('regimen','=','cualquiera'), ('regimen','=',regimen)]"/>
                      <field name="currency_id"/>
                    </group>

                    <group string="Resultado">
                      <field name="pedimento_numero"/>
                      <field name="fecha_pago"/>
                      <field name="semaforo"/>
                      <field name="fecha_liberacion"/>
                    </group>
                  </group>

                  <group>
                    <group string="Observaciones">
                      <field name="observaciones" placeholder="Notas internas del pedimento..."/>
                    </group>
                  </group>
                </sheet>
              </form>

            </field>
          </page>

        </xpath>

      </field>
    </record>

  </data>
</odoo>
